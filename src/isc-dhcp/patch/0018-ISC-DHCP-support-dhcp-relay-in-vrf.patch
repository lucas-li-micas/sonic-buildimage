From 58d694a46ad48776c7f20d8f19f453478c1863e2 Mon Sep 17 00:00:00 2001
From: mirror-bot <mirror@github-actions>
Date: Mon, 7 Jul 2025 02:10:44 -0500
Subject: [PATCH] ISC-DHCP-support-dhcp-relay-in-vrf

---
 common/socket.c  |  8 ++++++++
 relay/dhcrelay.c | 13 ++++++++++---
 2 files changed, 18 insertions(+), 3 deletions(-)

diff --git a/common/socket.c b/common/socket.c
index 87c62a2..e274d4e 100644
--- a/common/socket.c
+++ b/common/socket.c
@@ -48,6 +48,8 @@
 #include <net/if_dl.h>
 #include <sys/dlpi.h>
 #endif
+char uplink_name[IFNAMSIZ];
+struct in_addr bind_ia;
 
 #ifdef USE_SOCKET_FALLBACK
 # if !defined (USE_SOCKET_SEND)
@@ -223,6 +225,12 @@ if_register_socket(struct interface_info *info, int family,
 		memcpy(&addr->sin_addr,
 		       &local_address,
 		       sizeof(addr->sin_addr));
+		if (0 <= strlen(uplink_name) && 0 == strcmp(info->name, uplink_name)) {
+		    memcpy(&addr->sin_addr, &bind_ia, sizeof(bind_ia.s_addr));
+		    char str_buf[IFNAMSIZ];
+		    inet_ntop(AF_INET,  &bind_ia, str_buf, sizeof(str_buf));
+		    log_info("bind uplink interface %s to ip:%s success ", uplink_name, str_buf);
+		}
 #ifdef HAVE_SA_LEN
 		addr->sin_len = sizeof(*addr);
 #endif
diff --git a/relay/dhcrelay.c b/relay/dhcrelay.c
index a516829..65e4161 100644
--- a/relay/dhcrelay.c
+++ b/relay/dhcrelay.c
@@ -44,7 +44,8 @@ int lexline;
 int lexchar;
 char *token_line;
 char *tlname;
-
+extern char uplink_name [];
+extern struct in_addr bind_ia; 
 const char *path_dhcrelay_pid = _PATH_DHCRELAY_PID;
 isc_boolean_t no_dhcrelay_pid = ISC_FALSE;
 /* False (default) => we write and use a pid file */
@@ -508,7 +509,7 @@ main(int argc, char **argv) {
 			if (++i == argc) {
 				usage(use_noarg, argv[i-1]);
 			}
-
+                        memcpy(uplink_name, argv[i], strlen(argv[i]));
 			request_v4_interface(argv[i], INTERFACE_UPSTREAM);
 		} else if (!strcmp(argv[i], "-id")) {
 #ifdef DHCPv6
@@ -724,7 +725,13 @@ main(int argc, char **argv) {
 			local_family = AF_INET;
 #endif
 			enable_support_for_dual_tor = 1;
- 		} else if (argv[i][0] == '-') {
+ 		} else if (!strcmp(argv[i], "-bind")) {
+		       if (++i == argc)
+			       usage(use_v4command, argv[i-1]);
+		       if (inet_pton(AF_INET, argv[i], &bind_ia)) {
+		               log_info("bind_ia is %s \n", argv[i]);
+		       }
+		} else if (argv[i][0] == '-') {
 			usage("Unknown command: %s", argv[i]);
  		} else {
 			struct hostent *he;
-- 
2.25.1

