From 5c38fd1612907680718e3fc37970cf99ef31bf08 Mon Sep 17 00:00:00 2001
From: mirror-bot <mirror@github-actions>
Date: Tue, 29 Jul 2025 01:42:09 -0500
Subject: [PATCH] 0018-ISC-DHCP-support-dhcp-relay-in-vrf

---
 common/socket.c  |  7 +++++++
 relay/dhcrelay.c | 10 +++++++++-
 2 files changed, 16 insertions(+), 1 deletion(-)

diff --git a/common/socket.c b/common/socket.c
index 87c62a2..4dfad76 100644
--- a/common/socket.c
+++ b/common/socket.c
@@ -48,6 +48,7 @@
 #include <net/if_dl.h>
 #include <sys/dlpi.h>
 #endif
+struct in_addr bind_ia;
 
 #ifdef USE_SOCKET_FALLBACK
 # if !defined (USE_SOCKET_SEND)
@@ -223,6 +224,12 @@ if_register_socket(struct interface_info *info, int family,
 		memcpy(&addr->sin_addr,
 		       &local_address,
 		       sizeof(addr->sin_addr));
+		if ((info->flags & INTERFACE_STREAMS) == INTERFACE_UPSTREAM) {
+		    memcpy(&addr->sin_addr, &bind_ia, sizeof(bind_ia.s_addr));
+		    char str_buf[IFNAMSIZ];
+		    inet_ntop(AF_INET,  &bind_ia, str_buf, sizeof(str_buf));
+		    log_info("bind uplink interface %s to ip:%s success ", info->name, str_buf);
+		}
 #ifdef HAVE_SA_LEN
 		addr->sin_len = sizeof(*addr);
 #endif
diff --git a/relay/dhcrelay.c b/relay/dhcrelay.c
index a516829..14750e1 100644
--- a/relay/dhcrelay.c
+++ b/relay/dhcrelay.c
@@ -44,6 +44,7 @@ int lexline;
 int lexchar;
 char *token_line;
 char *tlname;
+extern struct in_addr bind_ia;
 
 const char *path_dhcrelay_pid = _PATH_DHCRELAY_PID;
 isc_boolean_t no_dhcrelay_pid = ISC_FALSE;
@@ -724,7 +725,14 @@ main(int argc, char **argv) {
 			local_family = AF_INET;
 #endif
 			enable_support_for_dual_tor = 1;
- 		} else if (argv[i][0] == '-') {
+ 		} else if (!strcmp(argv[i], "-bind")) {
+                       if (++i == argc) {
+			       usage(use_v4command, argv[i-1]);
+		       }
+		       if (inet_pton(AF_INET, argv[i], &bind_ia)) {
+			   log_info("bind_ia is %s \n", argv[i]);
+		       }
+		} else if (argv[i][0] == '-') {
 			usage("Unknown command: %s", argv[i]);
  		} else {
 			struct hostent *he;
-- 
2.25.1

